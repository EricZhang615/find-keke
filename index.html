<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="author" content="https://github.com/plazum/find-keke">
    <style>
      body {
        text-align: center;
        margin: 0;
      }
      div {
        display: grid;
      }
      table {
        border-collapse: collapse;
      }
      tr {
        display: flex;
      }
      td {
        display: contents;
      }
      input:invalid {
        border: 2px dashed red;
      }
      input[type="radio"], input[type="checkbox"] {
        transform: scale(1.2);
      }
      input[type="number"] {
        width: 3em;
        font-size: large;
        margin-right: 0.25em;
      }
      button {
        font-size: large;
      }
    </style>
    <script>
      "use strict";
      let time, d, time_string, last_rows, last_cols, hinted, language = navigator.language.substring(0, 2).toLowerCase();
      console.log("%c ", "display: inline-block; padding: 37.5px 37.5px; background: url(https://zrtech.org/find-keke/keke.jpg) no-repeat;");
      console.log("是真的");

      function show_bubu() {
        if (document.getElementById("result").style.display !== "none")
          return;
        document.getElementById("bubu").style.display = "";
        document.getElementById("bubu_video").play();
        window.scrollTo({top: 0, behavior: "smooth"});
      }

      function start_timing() {
        time = Date.now();
      }

      // 从以10毫秒为单位的整数转换成以秒为单位的精确到两位小数的字符串
      function time_to_string(time) {
        let time_string = (time / 100).toString();
        if (time % 100 === 0)
          time_string += ".00";
        else if (time % 10 === 0)
          time_string += "0";
        return time_string;
      }

      function write_result() {
        if (!hinted) {
          if (time <= 300) {
            const text1 = {
              zh: `恭喜你在三秒内找到了唐可可！用时${time_string}秒。`,
              ja: `おめでとうございます！三秒以内で唐可可を見つけました。${time_string}秒かかりました。`,
              en: `Congratulations! You have found Tang Keke within three seconds. ${time_string} seconds taken.`
            };
            document.getElementById("time1").innerHTML = text1[language];
            document.getElementById("niubi").style.display = "";
          } else {
            const text2 = {
              zh: `恭喜你找到了唐可可！用时${time_string}秒。`,
              ja: `おめでとうございます！唐可可を見つけました。${time_string}秒かかりました。`,
              en: `Congratulations! You have found Tang Keke. ${time_string} seconds taken.`
            };
            document.getElementById("time2").innerHTML = text2[language];
            document.getElementById("time2").style.display = "";
          }
        } else {
          const text3 = {
            zh: `经过提示，你终于在${time_string}秒的时候找到了唐可可。`,
            ja: `ヒントを使って、${time_string}秒でようやく唐可可を見つけました。`,
            en: `You have finally found Tang Keke after hinted at the ${time_string}th second.`
          };
          document.getElementById("time2").innerHTML = text3[language];
          document.getElementById("time2").style.display = "";
        }
      }

      function finish() {
        d = new Date();
        if (document.getElementById("result").style.display !== "none")
          return;
        time = d.getTime() - time;
        time = Math.floor(time / 10);
        // 判断任意棋盘大小下的用时等效小于等于3秒的规则为(time / (rows * cols)) <= (3 / (14 * 10))
        // 注意此处单位为10毫秒
        const in_time_limit = time * 14 * 10 <= 300 * last_rows * last_cols;
        time_string = time_to_string(time);
        write_result();
        document.getElementById("result").style.display = "";
        document.getElementById("good_video").play();
        document.getElementById("bubu").style.display = "none";
        document.getElementById("keke").style.filter = "drop-shadow(2px 4px 6px black)";
        document.getElementById("hint").setAttribute("disabled", "");
        document.getElementById("scoreboard").style.display = "none";
        setTimeout(() => window.scrollTo({top: 0, behavior: "smooth"}), 1);
        if (!hinted && in_time_limit)
          upload_score();
      }

      function generate_map(rows, cols) {
        let board = [];
        let content = "";
        let selected = [];

        for (let i = 0; i < image.length; i++) {
          if (document.getElementById(i.toString()).checked) {
            selected.push(image[i].filename);
          }
        }
        if (selected.length === 0)
          return;

        reset();
        last_rows = rows;
        last_cols = cols;
        const x = Math.floor(Math.random() * rows);
        const y = Math.floor(Math.random() * cols);
        for (let i = 0; i < rows; i++) {
          board[i] = Array.from({length: cols}, () => Math.floor(Math.random() * selected.length));
        }
        for (let i = 0; i < rows; i++) {
          content += "<tr>";
          for (let j = 0; j < cols; j++) {
            content += "<td>" + (i === x && j === y ?
              '<img id="keke" onclick="finish()" src="keke.jpg">'
              :
              '<img onclick="show_bubu()" src="' + selected[board[i][j]] + '">'
            ) + "</td>";
          }
          content += "</tr>";
        }
        document.getElementById("banner").style.width = Math.max(cols * 75, 750) + "px";
        document.getElementById("map").innerHTML = content;
        start_timing();
      }

      function reset() {
        document.getElementById("result").style.display = "none";
        document.getElementById("niubi").style.display = "none";
        document.getElementById("time2").style.display = "none";
        document.getElementById("bubu").style.display = "none";
        document.getElementById("upload_status").style.display = "none";
        document.getElementById("scoreboard").style.display = "";
        document.getElementById("good_video").pause();
        document.getElementById("bubu_video").pause();
        document.getElementById("hint").removeAttribute("disabled");
        hinted = false;
      }

      function hint() {
        document.getElementById("keke").style.filter = "drop-shadow(2px 4px 6px black)";
        document.getElementById("hint").setAttribute("disabled", "");
        hinted = true;
      }

      function get_token() {
        let e = "!E;!G.!V%!6D![] jR!!t!Yj!%Z!Yj =m =m c' }/ {<!Lf!;| {< fl Jq!T2!Lf!I! q} G, Ld H~!+3 h_!NY!:* n8!:*!]P AS n8!CH!CH!NY!fn", d = "";
        for (let i = 0; i < e.length / 3; i++) d += String.fromCharCode(((e.charCodeAt(i * 3) - " ".charCodeAt(0)) * 9025 + (e.charCodeAt(i * 3 + 1) - " ".charCodeAt(0)) * 95 + (e.charCodeAt(i * 3 + 2) - " ".charCodeAt(0))) / (new Error()).stack.split(":")[2 + isNaN((new Error()).stack.split(":")[2])] + " ".charCodeAt(0));
        return d;
      }

      const placeholder = {
        zh: ["涩谷香音", "唐可可", "岚千砂都", "平安名堇", "叶月恋", "圣泽悠奈", "柊摩央"],
        ja: ["澁谷かのん", "唐可可", "嵐千砂都", "平安名すみれ", "葉月恋", "聖澤悠奈", "柊摩央"],
        en: ["Shibuya Kanon", "Tang Keke", "Arashi Chisato", "Heanna Sumire", "Hazuki Ren", "Hijirisawa Yuuna", "Hiiragi Mao"]
      };
      let name_default, name_safe_for_html;

      function write_upload_status() {
        const text_uploaded = {
          zh: `分数已上传：${name_safe_for_html}；${last_rows}行×${last_cols}列；用时${time_string}秒<br>${d}`,
          ja: `点数がアップロードしました：${name_safe_for_html}；${last_rows}行×${last_cols}列；${time_string}秒かかりました<br>${d}`,
          en: `Score uploaded: ${name_safe_for_html}; ${last_rows} rows × ${last_cols} columns; ${time_string} seconds taken<br>${d}`
        };
        document.getElementById("upload_status").innerHTML = text_uploaded[language];
      }

      async function upload_score() {
        const time_limit = Math.floor(300 * last_rows * last_cols / (14 * 10));
        const time_limit_string = time_to_string(time_limit);
        const text_prompt = {
          zh: "恭喜你本次的等效用时小于或等于3秒！\n"
            + "（等效用时指的是将用时按照棋盘大小按比例折算成14×10棋盘之后的时间。）\n"
            + `（本次用时为${time_string}秒，棋盘大小为${last_rows}×${last_cols}，`
            + `想要使等效用时小于或等于3秒，你的用时必须小于或等于${time_limit_string}秒。）\n\n`
            + "请输入你的玩家名（如果不想上传分数，请点击取消或留空）",
          ja: "おめでとうございます！等価時間は3秒以下です。\n"
            + "（等価時間というのは、かかった時間にボードのサイズに対する14×10ボードのサイズの比率をかけた時間です。）\n"
            + `（今回かかった時間は${time_string}秒、ボードのサイズは${last_rows}×${last_cols}で、`
            + `等価時間が3秒以下になる場合、かかった時間が${time_limit_string}秒以下にならなければなりません。）\n\n`
            + "プレイヤーネームを入力してください（もし点数をアップロードしたくないなら、キャンセルをクリック、あるいは入力しないでください）",
          en: "Congratulations! The time you spent is equivalently less than or equal to 3 seconds.\n"
            + "(The equivalently-taken time means the time you spent after proportionally converting the board to the 14×10 board based on the board size.)\n"
            + `(You have spent ${time_string} seconds, and the board size is ${last_rows}×${last_cols}, `
            + `so in order to make the time you spent equivalently less than or equal to 3 seconds, you must spend less than or equal to ${time_limit_string} seconds.)\n\n`
            + "Please input you player name (or click Cancel or leave it empty if you do not want to upload your score)"
        };
        let name = prompt(text_prompt[language], name_default);
        if (name == null)
          return;
        name = name.trim();
        if (name === "")
          return;

        name_default = name;
        name_safe_for_html = name.replace(/</g, "&lt;").replace(/>/g, "&gt;"); // 防止用户输入HTML代码
        name = name_safe_for_html.replace(/%/g, "&#37;")
          .replace(/\\/g, "\\\\")
          .replace(/\|/g, "\\|"); // 防止用户输入Markdown表格分列符、反斜杠和百分号
        upload_score.text_uploading = upload_score.text_uploading || {
          zh: "上传中，请稍候……",
          ja: "アップロード中です。お待ちください…",
          en: "Please wait while uploading…"
        }; // 模拟静态局部变量
        document.getElementById("upload_status").innerHTML = upload_score.text_uploading[language];
        document.getElementById("upload_status").style.display = "";
        const data = {
          ref: "master",
          inputs: {
            player_name: name,
            rows: last_rows.toString(),
            cols: last_cols.toString(),
            score: time_string,
            time: d.toString()
          }
        };

        let retry = true;
        do {
          let fetch_fail = false;
          const response = await fetch(
            "https://api.github.com/repos/plazum/find-keke/actions/workflows/add-score.yml/dispatches",
            {
              method: "POST",
              headers: {
                Accept: "application/vnd.github.v3+json",
                Authorization: "token " + get_token()
              },
              body: JSON.stringify(data)
            }
          )
            .catch(error => {
              fetch_fail = true;
              const text_fetch_error = {
                zh: `Fetch API抛出错误“${error}”，是否重试？`,
                ja: `Fetch APIに「${error}」というエラーが発生しました。再試行しますか？`,
                en: `Fetch API throws error "${error}", retry?`
              };
              retry = confirm(text_fetch_error[language]);
            });
          if (fetch_fail) {
            if (retry)
              continue;
            else
              break;
          }

          const text = await response.text();
          if (response.ok) {
            write_upload_status();
            const text_github_rest_api_succeeded = {
              zh: `上传成功！\nGitHub REST API返回如下\n${response.status} ${response.statusText}\n${text}`,
              ja: `アップロード成功しました！\nGitHub REST APIの戻り値は以下になります\n${response.status} ${response.statusText}\n${text}`,
              en: `Successfully uploaded! \nGitHub REST API returns as follows\n${response.status} ${response.statusText}\n${text}`
            };
            alert(text_github_rest_api_succeeded[language]);
            break;
          } else {
            const text_github_rest_api_failed = {
              zh: `GitHub REST API失败，返回如下\n${response.status} ${response.statusText}\n${text}是否重试？`,
              ja: `GitHub REST APIが失敗しました。戻り値は以下になります\n${response.status} ${response.statusText}\n${text}再試行しますか？`,
              en: `GitHub REST API fails, returning as follows\n${response.status} ${response.statusText}\n${text}Retry?`
            };
            retry = confirm(text_github_rest_api_failed[language]);
          }
        } while (retry);
        if (document.getElementById("upload_status").innerHTML === upload_score.text_uploading[language])
          document.getElementById("upload_status").style.display = "none";
      }

      const UI_text = {
        title: {
          zh: "寻找唐可可",
          ja: "唐可可を探せ",
          en: "Find out Tang Keke"
        },
        scoreboard: {
          zh: "查看计分板和最高纪录↗",
          ja: "スコアボードと最高記録↗",
          en: "See the scoreboard and top records↗"
        },
        classic_mode: {
          zh: "经典模式14×10",
          ja: "クラシックモード14×10",
          en: "Classic Mode 14×10"
        },
        extended_mode: {
          zh: "扩展模式14×14",
          ja: "広がりモード14×14",
          en: "Extended Mode 14×14"
        },
        hard_mode: {
          zh: "困难模式20×14",
          ja: "困難モード20×14",
          en: "Hard Mode 20×14"
        },
        row: {
          zh: "行",
          ja: "行",
          en: "Rows"
        },
        column: {
          zh: "列",
          ja: "列",
          en: "Columns"
        },
        customize_mode: {
          zh: "自定义模式",
          ja: "カスタマイズモード",
          en: "Customize Mode"
        },
        hint: {
          zh: "来点提示",
          ja: "ヒント頂戴",
          en: "Hint"
        },
        debug: {
          zh: "想要一击必胜？点此前往调试模式",
          ja: "ワンクリックで勝ちたい？ここにデバッグモードへ",
          en: "Want to win at a single click? Click here for Debug Mode"
        },
        new_game: {
          zh: "再来一局",
          ja: "もう一回",
          en: "New Game"
        },
        github: {
          zh: "来GitHub上切克闹（指check it out）吧↗",
          ja: "GitHubでチェケラッ（check it out）↗",
          en: "Check it out on GitHub↗"
        },
        wrong: {
          zh: "不是这个哦，请再试一次。",
          ja: "間違ったよ。もう一度お試しください。",
          en: "Wrong. Please try again."
        },
        give_up: {
          zh: "累了，我要重开（指游戏）",
          ja: "もういい、やり直しだ",
          en: "Give Up and New Game"
        }
      };

      function set_language(value) {
        language = value;

        const UI = [
          "scoreboard", "classic_mode", "extended_mode", "hard_mode",
          "row", "column", "customize_mode", "hint",
          "new_game", "github", "wrong", "give_up"
        ];
        document.title = UI_text.title[language];
        for (let i = 0; i < UI.length; i++) {
          document.getElementById(UI[i]).innerHTML = UI_text[UI[i]][language];
        }
        document.getElementById("scoreboard2").innerHTML = UI_text.scoreboard[language];
        if (document.getElementById("debug"))
          document.getElementById("debug").title = UI_text.debug[language];
        for (let i = 0; i < image.length; i++) {
          document.getElementById("label_" + i).innerHTML = image[i].name[language];
        }
        name_default = location.href.startsWith("https://zrtech.org/") ?
          placeholder[language][Math.floor(Math.random() * placeholder.zh.length)]
          :
          "test（本地开发测试用）"
        ;
        if (document.getElementById("result").style.display !== "none")
          write_result();
        if (document.getElementById("upload_status").style.display !== "none")
          write_upload_status();
      }
    </script>
  </head>
  <body>
    <div>
      <div id="result" style="display: none;">
        <table id="niubi" style="display: none; margin: 1em auto 1em auto;">
          <tr>
            <td><h1 id="time1" style="margin: auto;"></h1></td>
            <td><img src="niubi.jpg" width="203" height="103"></td>
          </tr>
        </table>
        <h1 id="time2" style="display: none;"></h1>
        <h1 id="upload_status" style="display: none;"></h1>
        <button id="new_game" style="margin: 0 auto 0 auto; font-size: x-large;" onclick="generate_map(last_rows, last_cols)">
        </button>
        <a id="scoreboard2" style="margin: 1em auto 0.5em auto; font-size: larger;" href="https://github.com/plazum/find-keke/issues/5" target="_blank">
        </a>
        <a id="github" style="margin: 0 auto 1.5em auto;" href="https://github.com/plazum/find-keke" target="_blank">
        </a>
        <video id="good_video" style="margin: auto;" src="good.mp4" loop></video>
      </div>
      <div id="bubu" style="display: none;">
        <h1 id="wrong"></h1>
        <button id="give_up" style="margin: auto auto 1em auto; font-size: x-large;" onclick="generate_map(last_rows, last_cols)">
        </button>
        <video id="bubu_video" style="margin: auto;" src="bubu.mp4" loop></video>
      </div>
      <div style="margin: 1.5em auto 1.25em auto; font-size: larger;">
        <div style="display: block; margin-bottom: 0.5em;">
          <label><input id="zh" type="radio" name="language" onchange="set_language('zh')">中文</label>
          <label><input id="ja" type="radio" name="language" onchange="set_language('ja')">日本語</label>
          <label><input id="en" type="radio" name="language" onchange="set_language('en')">English</label>
        </div>
        <a id="scoreboard" style="margin: 0 auto 0.5em auto;" href="https://github.com/plazum/find-keke/issues/5" target="_blank">
        </a>
        <div style="display: block; margin-bottom: 0.75em;" id="filter"></div>
        <div style="display: block;">
          <button id="classic_mode" onclick="generate_map(14, 10)"></button>
          <button id="extended_mode" onclick="generate_map(14, 14)"></button>
          <button id="hard_mode" onclick="generate_map(20, 14)"></button>
          <form style="display: inline-block;"
                onsubmit="generate_map(document.getElementById('rows').value, document.getElementById('cols').value); return false;">
            <input id="rows" type="number" value="20" min="1" required><label id="row" for="rows"></label>
            ×
            <input id="cols" type="number" value="20" min="1" required><label id="column" for="cols"></label>
            <button id="customize_mode" type="submit"></button>
          </form>
          <button id="hint" onclick="hint()"></button>
        </div>
      </div>
      <a id="debug" href="debug" style="display: contents;" title="" target="_blank">
        <div id="banner" style="margin: auto; background-image: url(banner-extension.jpg);">
          <img style="margin: auto;" src="banner.jpg">
        </div>
      </a>
      <table id="map" style="margin: auto;">
      </table>
      <script>
        // 在此处添加角色信息
        const image = [
          {
            filename: "kotori.jpg",
            name: {
              zh: "南小鸟",
              ja: "南ことり",
              en: "Minami Kotori"
            }
          },
          {
            filename: "you.jpg",
            name: {
              zh: "渡边曜",
              ja: "渡辺曜",
              en: "Watanabe You"
            }
          },
        ];
        document.getElementById("filter").innerHTML = image.map(
          (val, idx) => '<input id="' + idx + '" type="checkbox" checked onchange="generate_map(last_rows, last_cols)">'
            + '<label id="label_' + idx + '" for="' + idx + '"></label>'
        ).join(" ");
        if (!["zh", "ja", "en"].includes(language))
          language = "en";
        document.getElementById(language).click();
        set_language(language);

        generate_map(14, 10);
      </script>
    </div>
  </body>
</html>
